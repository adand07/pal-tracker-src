From 1e0a13b2c4db22d9242e96ce6b011da00bd2c9bd Mon Sep 17 00:00:00 2001
From: Mike Gehard <mike.gehard@gmail.com>
Date: Tue, 9 Jan 2018 09:47:21 -0700
Subject: [PATCH 09/16] Add task for migrating databases

---
 ci/migrateDatabase.yml       | 29 +++++++++++++++++++++++++++++
 scripts/migrate-databases.sh | 23 +++++++++++++++++++++++
 2 files changed, 52 insertions(+)
 create mode 100644 ci/migrateDatabase.yml
 create mode 100644 scripts/migrate-databases.sh

diff --git a/ci/migrateDatabase.yml b/ci/migrateDatabase.yml
new file mode 100644
index 0000000..b2af8c5
--- /dev/null
+++ b/ci/migrateDatabase.yml
@@ -0,0 +1,29 @@
+platform: linux
+
+image_resource:
+  type: docker-image
+  source:
+    repository: openjdk
+    tag: '8-jdk'
+
+inputs:
+  - name: pal-tracker
+#  - name: version
+
+#outputs:
+#  - name: build-output
+
+run:
+  path: bash
+  args:
+  - -exc
+  - |
+    cd pal-tracker
+    curl -L "https://packages.cloudfoundry.org/stable?release=linux64-binary&source=github" | tar -zx
+    chmod +x cf
+    curl -L "https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/5.0.5/flyway-commandline-5.0.5-linux-x64.tar.gz" | tar -zx
+    chmod +x flyway-5.0.5/flyway
+    ./cf login -a $CF_API_URL -u $CF_USERNAME -p $CF_PASSWORD -o $CF_ORG -s $CF_SPACE
+    ./cf ssh -N -L 63306:$MYSQL_IP:3306 pal-tracker &
+    sleep 2
+    ./flyway-5.0.5/flyway -url="jdbc:mysql://127.0.0.1:63306/$DATABASE_NAME" -locations=filesystem:databases/tracker -user=$DATABASE_USERNAME -password=$DATABASE_PASSWORD clean migrate
diff --git a/scripts/migrate-databases.sh b/scripts/migrate-databases.sh
new file mode 100644
index 0000000..d09bbce
--- /dev/null
+++ b/scripts/migrate-databases.sh
@@ -0,0 +1,23 @@
+#!/usr/bin/env bash
+set -e
+
+
+app_guid=`cf app $1 --guid`
+credentials=`cf curl /v2/apps/$app_guid/env | jq '.system_env_json.VCAP_SERVICES' | jq '.["p-mysql"][0].credentials'`
+
+ip_address=`echo $credentials | jq -r '.hostname'`
+db_name=`echo $credentials | jq -r '.name'`
+db_username=`echo $credentials | jq -r '.username'`
+db_password=`echo $credentials | jq -r '.password'`
+
+echo "Opening ssh tunnel to $ip_address"
+cf ssh -N -L 63306:$ip_address:3306 pal-tracker &
+cf_ssh_pid=$!
+
+echo "Waiting for tunnel"
+sleep 5
+
+# Passing this in as a param is a bit strage. Maybe put flyway on the path?
+$3/flyway-*/flyway -url="jdbc:mysql://127.0.0.1:63306/$db_name" -locations=filesystem:$2/databases/tracker -user=$db_username -password=$db_password migrate
+
+kill -STOP $cf_ssh_pid
-- 
2.12.3

