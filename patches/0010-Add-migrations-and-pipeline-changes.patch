From 67481c00fff64749d1f6707a6c69cd06580edc74 Mon Sep 17 00:00:00 2001
From: Tyson Gern <tgern@pivotal.io>
Date: Thu, 20 Jul 2017 16:00:48 -0600
Subject: [PATCH 10/16] Add migrations and pipeline changes

---
 .circleci/config.yml                               | 32 ++++++++++++++++++++--
 ci/migrateDatabase.yml                             | 29 --------------------
 databases/tracker/create_databases.sql             | 11 ++++++++
 .../tracker/migrations/V1__initial_schema.sql      | 11 ++++++++
 4 files changed, 52 insertions(+), 31 deletions(-)
 delete mode 100644 ci/migrateDatabase.yml
 create mode 100644 databases/tracker/create_databases.sql
 create mode 100644 databases/tracker/migrations/V1__initial_schema.sql

diff --git a/.circleci/config.yml b/.circleci/config.yml
index 240f208..30bcdd0 100644
--- a/.circleci/config.yml
+++ b/.circleci/config.yml
@@ -43,11 +43,25 @@ jobs:
             sudo apt-get install cf-cli
 
       - run:
-          name: Deploy to review
+          name: Install jq
+          command: |
+            sudo apt-get -y install jq
+
+      - run:
+          name: Install flyway
+          command: |
+            curl https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/5.1.1/flyway-commandline-5.1.1-linux-x64.tar.gz | tar xvz
+
+
+      - run:
+          name: Deploy to review and migrate
           command: |
             cf login -a $CF_API -u $CF_USERNAME -p $CF_PASSWORD -o $CF_ORG -s $ENVIRONMENT
             cf push -f manifest-$ENVIRONMENT.yml -p artifacts/pal-tracker-$CIRCLE_SHA1.jar
 
+            ./scripts/migrate-databases.sh pal-tracker . /home/circleci/project/
+
+
   deployToProd:
     docker:
       - image: circleci/openjdk:8-jdk
@@ -69,10 +83,24 @@ jobs:
             sudo apt-get install cf-cli
 
       - run:
-          name: Deploy to prod
+          name: Install jq
+          command: |
+            sudo apt-get -y install jq
+
+      - run:
+          name: Install flyway
+          command: |
+            curl https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/5.1.1/flyway-commandline-5.1.1-linux-x64.tar.gz | tar xvz
+
+
+      - run:
+          name: Deploy to prod and migrate
           command: |
             cf login -a $CF_API -u $CF_USERNAME -p $CF_PASSWORD -o $CF_ORG -s $ENVIRONMENT
             cf push -f manifest-$ENVIRONMENT.yml -p artifacts/pal-tracker-$CIRCLE_SHA1.jar
+
+            ./scripts/migrate-databases.sh pal-tracker . /home/circleci/project/
+
 workflows:
   version: 2
   deployment-pipeline:
diff --git a/ci/migrateDatabase.yml b/ci/migrateDatabase.yml
deleted file mode 100644
index b2af8c5..0000000
--- a/ci/migrateDatabase.yml
+++ /dev/null
@@ -1,29 +0,0 @@
-platform: linux
-
-image_resource:
-  type: docker-image
-  source:
-    repository: openjdk
-    tag: '8-jdk'
-
-inputs:
-  - name: pal-tracker
-#  - name: version
-
-#outputs:
-#  - name: build-output
-
-run:
-  path: bash
-  args:
-  - -exc
-  - |
-    cd pal-tracker
-    curl -L "https://packages.cloudfoundry.org/stable?release=linux64-binary&source=github" | tar -zx
-    chmod +x cf
-    curl -L "https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/5.0.5/flyway-commandline-5.0.5-linux-x64.tar.gz" | tar -zx
-    chmod +x flyway-5.0.5/flyway
-    ./cf login -a $CF_API_URL -u $CF_USERNAME -p $CF_PASSWORD -o $CF_ORG -s $CF_SPACE
-    ./cf ssh -N -L 63306:$MYSQL_IP:3306 pal-tracker &
-    sleep 2
-    ./flyway-5.0.5/flyway -url="jdbc:mysql://127.0.0.1:63306/$DATABASE_NAME" -locations=filesystem:databases/tracker -user=$DATABASE_USERNAME -password=$DATABASE_PASSWORD clean migrate
diff --git a/databases/tracker/create_databases.sql b/databases/tracker/create_databases.sql
new file mode 100644
index 0000000..8b5ed7b
--- /dev/null
+++ b/databases/tracker/create_databases.sql
@@ -0,0 +1,11 @@
+DROP DATABASE IF EXISTS tracker_dev;
+DROP DATABASE IF EXISTS tracker_test;
+
+CREATE DATABASE tracker_dev;
+CREATE DATABASE tracker_test;
+
+CREATE USER IF NOT EXISTS 'tracker'@'localhost'
+  IDENTIFIED BY '';
+GRANT ALL PRIVILEGES ON tracker_dev.* TO 'tracker' @'localhost';
+GRANT ALL PRIVILEGES ON tracker_test.* TO 'tracker' @'localhost';
+
diff --git a/databases/tracker/migrations/V1__initial_schema.sql b/databases/tracker/migrations/V1__initial_schema.sql
new file mode 100644
index 0000000..3e605c0
--- /dev/null
+++ b/databases/tracker/migrations/V1__initial_schema.sql
@@ -0,0 +1,11 @@
+CREATE TABLE time_entries (
+  id         BIGINT(20) NOT NULL AUTO_INCREMENT,
+  project_id BIGINT(20),
+  user_id    BIGINT(20),
+  date       DATE,
+  hours      INT,
+
+  PRIMARY KEY (id)
+)
+  ENGINE = innodb
+  DEFAULT CHARSET = utf8;
-- 
2.12.3

