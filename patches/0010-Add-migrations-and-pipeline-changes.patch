From 009095394fccecb796fefc49bef66b19afb73054 Mon Sep 17 00:00:00 2001
From: Tyson Gern <tgern@pivotal.io>
Date: Thu, 20 Jul 2017 16:00:48 -0600
Subject: [PATCH 10/16] Add migrations and pipeline changes

---
 .travis.yml                                         | 19 ++++++++++++++++---
 databases/tracker/create_databases.sql              | 11 +++++++++++
 databases/tracker/migrations/V1__initial_schema.sql | 11 +++++++++++
 3 files changed, 38 insertions(+), 3 deletions(-)
 create mode 100644 databases/tracker/create_databases.sql
 create mode 100644 databases/tracker/migrations/V1__initial_schema.sql

diff --git a/.travis.yml b/.travis.yml
index 4cbb913..7738acf 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -4,15 +4,19 @@ notifications:
   email: false
 env:
   - RELEASE_TAG="release-$TRAVIS_BUILD_NUMBER"
-if: tag IS blank
-
 
 jobs:
   include:
     - stage: build and publish
       language: java
       jdk: oraclejdk8
+     addons:
+       mariadb: '10.2'
       install: skip
+     before_script:
+       - mysql -uroot < databases/tracker/create_databases.sql
+       - curl https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/5.1.1/flyway-commandline-5.1.1-linux-x64.tar.gz | tar xvz
+       - flyway-*/flyway -url="jdbc:mysql://localhost:3306/tracker_test" -locations=filesystem:databases/tracker -user=tracker clean migrate
       script: ./gradlew clean build
       before_deploy:
         - git config --local user.name "Travis CI"
@@ -24,12 +28,21 @@ jobs:
         file: "build/libs/pal-tracker.jar"
         skip_cleanup: true
     - stage: deploy to review
-      language: bash
+      language: java
+     before_install:
+       - wget -q -O - https://packages.cloudfoundry.org/debian/cli.cloudfoundry.org.key | sudo apt-key add -
+       - echo "deb https://packages.cloudfoundry.org/debian stable main" | sudo tee /etc/apt/sources.list.d/cloudfoundry-cli.list
+       - sudo apt-get update
+       - sudo apt-get install cf-cli
+       - sudo apt-get -y install jq
       script:
         - echo "Downloading $RELEASE_TAG"
         - wget -P build/libs https://github.com/$GITHUB_USERNAME/pal-tracker/releases/download/$RELEASE_TAG/pal-tracker.jar
       before_deploy:
         - echo "Deploying $RELEASE_TAG to review"
+     after_success:
+       - cf login -a $CF_API_URL -u $CF_USERNAME -p $CF_PASSWORD -o $CF_ORG -s review
+       - scripts/.migrate-databases.sh
       deploy:
         provider: cloudfoundry
         api: $CF_API_URL
diff --git a/databases/tracker/create_databases.sql b/databases/tracker/create_databases.sql
new file mode 100644
index 0000000..8b5ed7b
--- /dev/null
+++ b/databases/tracker/create_databases.sql
@@ -0,0 +1,11 @@
+DROP DATABASE IF EXISTS tracker_dev;
+DROP DATABASE IF EXISTS tracker_test;
+
+CREATE DATABASE tracker_dev;
+CREATE DATABASE tracker_test;
+
+CREATE USER IF NOT EXISTS 'tracker'@'localhost'
+  IDENTIFIED BY '';
+GRANT ALL PRIVILEGES ON tracker_dev.* TO 'tracker' @'localhost';
+GRANT ALL PRIVILEGES ON tracker_test.* TO 'tracker' @'localhost';
+
diff --git a/databases/tracker/migrations/V1__initial_schema.sql b/databases/tracker/migrations/V1__initial_schema.sql
new file mode 100644
index 0000000..3e605c0
--- /dev/null
+++ b/databases/tracker/migrations/V1__initial_schema.sql
@@ -0,0 +1,11 @@
+CREATE TABLE time_entries (
+  id         BIGINT(20) NOT NULL AUTO_INCREMENT,
+  project_id BIGINT(20),
+  user_id    BIGINT(20),
+  date       DATE,
+  hours      INT,
+
+  PRIMARY KEY (id)
+)
+  ENGINE = innodb
+  DEFAULT CHARSET = utf8;
-- 
2.12.3

